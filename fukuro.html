<!DOCTYPE html>
<html lang="es-MX">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>FUKURO - A/V SYNTHESIS</title>
	
	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	
	<!-- Three.js Library -->
	<script type="importmap">
		{
			"imports": {
				"three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
				"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
			}
		}
	</script>
	
	<!-- Google Fonts (VT323 & DotGothic16 for Japanese) -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=VT323&display=swap" rel="stylesheet">

	<style>
		/* Estilos personalizados para la estética "acid" - TEMA BLANCO */
		body {
			font-family: 'VT323', monospace;
			background-color: #000000;
			color: #e0e0e0; /* Color principal: Blanco LED */
			overflow: hidden;
		}
		
		/* Estilo para Katakana */
		.katakana {
			font-family: 'DotGothic16', monospace;
			font-weight: 400;
		}

		#three-canvas {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: -1;
			outline: none;
		}

		/* Animación Glitch (Conserva colores "acid") */
		@keyframes glitch {
			0% { text-shadow: 2px 0 #ff00ff, -2px 0 #00ffff; transform: translate(0); }
			20% { text-shadow: 1px 1px #ff00ff, -1px -1px #00ffff; transform: translate(-1px, 1px); }
			40% { text-shadow: -2px 1px #ff00ff, 2px -1px #00ffff; transform: translate(1px, -1px); }
			60% { text-shadow: 1px -2px #ff00ff, -1px 2px #00ffff; transform: translate(-1px, 1px); }
			80% { text-shadow: -1px 2px #ff00ff, 1px -2px #00ffff; transform: translate(1px, -1px); }
			100% { text-shadow: 2px 0 #ff00ff, -2px 0 #00ffff; transform: translate(0); }
		}

		.glitch-text {
			animation: glitch 0.5s cubic-bezier(.25, .46, .45, .94) both infinite;
		}

		/* Sombra de "neón" ahora blanca */
		.neon-shadow {
			text-shadow: 0 0 5px #e0e0e0, 0 0 10px #e0e0e0, 0 0 20px #e0e0e0, 0 0 40px #e0e0e0;
		}

		.content-box {
			background-color: rgba(16, 16, 16, 0.75);
			backdrop-filter: blur(10px) saturate(200%);
			-webkit-backdrop-filter: blur(10px) saturate(200%);
			border: 1px solid #e0e0e0; /* Borde Blanco */
			box-shadow: 0 0 15px rgba(224, 224, 224, 0.3); /* Sombra Blanca */
		}

		::selection { background: #ff00ff; color: #000000; }
		
		.content-box-inner::-webkit-scrollbar { width: 8px; }
		.content-box-inner::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); }
		.content-box-inner::-webkit-scrollbar-thumb { background-color: #e0e0e0; border: 1px solid #000; } /* Scrollbar Blanca */

		.nav-link {
			transition: all 0.2s ease-in-out;
			text-shadow: 0 0 5px #e0e0e0; /* Sombra de texto Blanca */
			cursor: pointer;
			text-align: center; /* Asegurar que el texto esté centrado */
		}
		.nav-link:hover, .nav-link.active {
			color: #000000;
			background-color: #e0e0e0; /* Fondo Blanco en hover/active */
			text-shadow: 0 0 5px #e0e0e0, 0 0 10px #e0e0e0;
			box-shadow: 0 0 10px #e0e0e0, 0 0 20px #e0e0e0;
		}
		
		.form-input, .form-textarea, .form-select {
			background-color: rgba(0, 0, 0, 0.5);
			border: 1px solid #e0e0e0; /* Borde Blanco */
			color: #e0e0e0; /* Texto Blanco */
			padding: 8px 12px;
			width: 100%;
			border-radius: 4px;
			font-family: 'VT323', monospace;
			font-size: 1.125rem;
			transition: all 0.2s ease;
		}
		/* Estilo para el selector de fecha */
		.form-input[type="date"] { color-scheme: dark; }
		.form-input[type="date"]::-webkit-calendar-picker-indicator {
			background-color: #e0e0e0; /* Indicador Blanco */
			border-radius: 2px;
			cursor: pointer;
		}
		/* Corregir el color de texto del select en Safari/iOS */
		.form-select option {
			background-color: #111;
			color: #e0e0e0;
		}

		.form-input:focus, .form-textarea:focus, .form-select:focus {
			outline: none;
			box-shadow: 0 0 10px #e0e0e0; /* Foco Blanco */
			background-color: rgba(0, 0, 0, 0.8);
		}
		/* Estilo para campos inválidos */
		.form-input.invalid, .form-textarea.invalid, .form-select.invalid {
			border-color: #ff0000; /* Borde Rojo */
			box-shadow: 0 0 10px #ff0000; /* Sombra Roja */
		}
		.form-input:read-only {
			background-color: rgba(0, 0, 0, 0.2);
			color: #e0e0e0;
			border-style: dashed;
		}
		.form-label { display: block; margin-bottom: 0.5rem; text-shadow: 0 0 3px #e0e0e0; }
		
		.form-checkbox { 
			margin-right: 0.5rem;
			accent-color: #facc15; /* Yellow-400 */
			transform: scale(1.5);
		}
		
		.submit-btn {
			background-color: transparent;
			border: 1px solid #e0e0e0; /* Botón Blanco */
			color: #e0e0e0;
		}
		.submit-btn:hover { background-color: #e0e0e0; color: #000000; box-shadow: 0 0 15px #e0e0e0; }
		.submit-btn:disabled {
			border-color: #555555; /* Deshabilitado Gris */
			color: #555555;
			cursor: not-allowed;
			background-color: rgba(0, 0, 0, 0.2);
			box-shadow: none;
		}

		/* Estilos de Impresión CORREGIDOS */
		@media print {
			body {
				background: #ffffff !important; /* Fondo blanco para impresión */
			}
			
			/* Ocultar TODO menos el contenedor del modal */
			#three-canvas, #main-app-container, footer {
				display: none !important;
			}
			
			#quote-modal {
				display: block !important;
				position: static !important;
				width: 100% !important;
				max-width: 100% !important;
				height: auto !important;
				max-height: none !important;
				overflow: visible !important;
				background: #ffffff !important;
				backdrop-filter: none !important;
				-webkit-backdrop-filter: none !important;
			}

			#quote-modal-content {
				display: block !important;
				position: static !important;
				width: 100% !important;
				max-width: 100% !important;
				height: auto !important;
				max-height: none !important;
				overflow: visible !important;
				background: #ffffff !important;
				color: #000000 !important;
				border: none !important;
				box-shadow: none !important;
				backdrop-filter: none !important;
				-webkit-backdrop-filter: none !important;
			}

			/* Muestra el contenedor de impresión y oculta el en vivo */
			#quote-summary-print-container { display: block !important; }
			#quote-summary { display: none !important; }
			
			#quote-summary-print {
				display: block !important;
				color: #000 !important;
				font-size: 12pt !important;
				font-family: Arial, sans-serif !important; /* Fuente segura para impresión */
			}
			
			#quote-summary-print h1 { font-size: 24pt; color: #000; font-weight: bold; }
			#quote-summary-print h2 { font-size: 18pt; color: #000; font-weight: bold; }
			#quote-summary-print p { font-size: 12pt; color: #000; margin-bottom: 8px; }
			#quote-summary-print strong { color: #333 !important; }
			#quote-summary-print .text-yellow-300 { color: #000 !important; font-weight: bold; }
			#quote-summary-print .text-red-500 { color: #cc0000 !important; font-weight: bold; }
			#quote-summary-print hr { border-color: #999 !important; }
			
			/* Ocultar botones e UI del modal */
			#modal-controls, #modal-overlay, #quote-modal-header h2 {
				display: none !important;
			}
			/* Ocultar el título de confirmar */
			#quote-modal-header h2 {
				display: none !important;
			}
		}
	</style>
</head>
<body class="w-full h-screen overflow-hidden text-base sm:text-lg md:text-xl">

	<!-- Canvas de Fondo 3D -->
	<canvas id="three-canvas"></canvas>

	<!-- UI Principal -->
	<!-- ID AÑADIDO AQUÍ para ocultar en impresión -->
	<div id="main-app-container" class="relative w-full h-full p-2 sm:p-4 md:p-6 lg:p-8 flex flex-col items-center justify-center">
		
		<main class="content-box rounded-lg w-full max-w-4xl h-full max-h-[90vh] md:max-h-[85vh] flex flex-col p-3 sm:p-4 md:p-6 lg:p-8">
			
			<!-- Header: Logo -->
			<header class="text-center mb-4 md:mb-6">
				<h1 class="text-5xl sm:text-7xl md:text-8xl font-bold glitch-text" style="color: #ffffff; text-shadow: 3px 3px #00ff00, -3px -3px #ff00ff;">
					FUKURO
				</h1>
				<p class="text-2xl sm:text-3xl md:text-4xl katakana neon-shadow">フクロウ</p>
				<p class="text-lg sm:text-xl md:text-3xl tracking-widest text-yellow-300" style="text-shadow: 0 0 5px #facc15, 0 0 10px #facc15;">
					A/V SYNTHESIS
				</p>
			</header>

			<!-- Área de Contenido (Directo al Formulario) -->
			<div id="content-area" class="content-box-inner flex-grow overflow-y-auto p-4 border border-dashed border-gray-500/50 rounded-lg">
				
				<!-- TÍTULO CAMBIADO AQUÍ -->
				<h2 class="text-2xl md:text-3xl neon-shadow mb-4">++ LET'S SYNTHESIZE ++</h2>
				<p class="mb-2 text-yellow-300">// La cotización final incluirá una Tarifa Base de $1200 MXN por *nuevo* proyecto.</p>
				<p class="mb-2 text-yellow-300">// El descuento del 50% aplica a la duración total acumulada después del primer minuto.</p>
				<p class="mb-4 text-yellow-300 font-bold">// El pago total se realiza contra-entrega de los archivos finales.</p>
				
				<!-- ID de FORMSPREE AÑADIDO AQUÍ -->
				<form id="quote-form" action="https://formspree.io/f/xjkjgqln" method="POST" class="space-y-6" novalidate>
					
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<label for="name" class="form-label">[ NOMBRE_CLIENTE ]</label>
							<input type="text" id="name" name="name" class="form-input text-lg" required>
							<div id="name-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
						</div>
						<div>
							<label for="email" class="form-label">[ EMAIL_CLIENTE ]</label>
							<input type="email" id="email" name="email" class="form-input text-lg" required>
							<div id="email-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
						</div>
					</div>

					<!-- CAMPO SPAMFIX AÑADIDO: _replyto -->
					<input type="hidden" name="_replyto" id="form-replyto">
					<!-- CAMPO SPAMFIX AÑADIDO: _subject -->
					<input type="hidden" name="_subject" id="form-subject">


					<div>
						<label for="project-name" class="form-label">[ NOMBRE_PROYECTO ]</label>
						<input type="text" id="project-name" name="project-name" class="form-input text-lg" required>
						<div id="project-name-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
					</div>

					<!-- Checkbox de Proyecto Existente -->
					<div class="pl-4">
						<label class="flex items-center text-yellow-300">
							<input type="checkbox" id="existing-project" name="existing-project" value="true" class="form-checkbox">
							<span class="ml-3">¿Es un añadido a un proyecto existente? (Omitir Tarifa Base)</span>
						</label>
					</div>


					<!-- Calculadora de Cotización -->
					<div id="quote-form-calculator" class="space-y-4">
						<label class="form-label">[ SERVICIO REQUERIDO ]</label>
						<div class="space-y-3" id="service-group">
							<label class="flex items-center">
								<input type="radio" id="service-audio" name="service_type" value="Audio" class="form-checkbox" required>
								<span class="ml-3">PRODUCCIÓN DE AUDIO ($2400/min)</span>
							</label>
							<label class="flex items-center">
								<input type="radio" id="service-video" name="service_type" value="Video" class="form-checkbox">
								<span class="ml-3">PRODUCCIÓN DE VIDEO (incluye audio) ($5000/min)</span>
							</label>
							<!-- Opción de Imagen/3D eliminada -->
						</div>
						<div id="service-type-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
						
						<!-- Flujo de Duración (oculto por defecto) -->
						<div id="duration-controls" class="hidden space-y-4 pt-4 border-t border-dashed border-gray-500/50">
							
							<!-- Layout de Fila Separada -->
							<div class="w-full sm:w-1/2">
								<label for="deliverable_quantity" class="form-label">[ CANTIDAD DE ENTREGABLES ]</label>
								<select id="deliverable_quantity" name="deliverable_quantity" class="form-select text-lg">
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
									<option value="4">4</option>
									<option value="5">5</option>
									<option value="6">6</option>
									<option value="7">7</option>
									<option value="8">8</option>
									<option value="9">9</option>
									<option value="10">10+</option>
								</select>
							</div>
							
							<!-- Layout de Fila Separada -->
							<div>
								<label class="form-label">[ DURACIÓN (POR C/U) ]</label>
								<div class="grid grid-cols-2 gap-4">
									<div>
										<label for="duration_min" class="form-label text-sm">[ MINUTOS ]</label>
										<input type="number" id="duration_min" name="duration_min" class="form-input text-lg" min="0" value="0" step="1">
									</div>
									<div>
										<label for="duration_sec" class="form-label text-sm">[ SEGUNDOS ]</label>
										<input type="number" id="duration_sec" name="duration_sec" class="form-input text-lg" min="0" max="59" step="1" value="0">
									</div>
								</div>
							</div>

							<input type="hidden" id="duration_total_minutes" name="duration_total_minutes">
							<!-- Inputs ocultos para almacenar los costos calculados -->
							<input type="hidden" id="calculated_base_fee" name="calculated_base_fee">
							<input type="hidden" id="calculated_production_fee" name="calculated_production_fee">


							<!-- Controles de Loop -->
							<div class="pl-4 space-y-4">
								<label class="flex items-center text-yellow-300"><input type="checkbox" id="is-loop" name="is-loop" value="true" class="form-checkbox"> ¿Repetir este contenido (loop)?</label>
								
								<div id="loop-final-duration-group" class="hidden">
									<label for="final-duration" class="form-label">[ DURACIÓN FINAL DEL ARCHIVO (informativo) ]</ISO_8601>
									<input type="text" id="final-duration" name="final-duration" class="form-input text-lg" placeholder="Ej: 1 min, 10 mins, 'loop indefinido'">
								</div>
							</div>
						</div>

						<!-- Especificaciones Técnicas (ocultas por defecto) -->
						<div id="tech-specs-av" class="hidden space-y-4 pt-4 border-t border-dashed border-gray-500/50">
							<label class="form-label text-yellow-300">[ ESPECIFICACIONES (AUDIO/VIDEO) ]</label>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label for="format_av" class="form-label text-sm">[ FORMATO (.MP4, .WAV...) ]</label>
									<input type="text" id="format_av" name="format_av" class="form-input text-lg">
								</div>
								<div>
									<label for="resolution_av" class="form-label text-sm">[ RESOLUCIÓN / CALIDAD ]</label>
									<input type="text" id="resolution_av" name="resolution_av" class="form-input text-lg">
								</div>
							</div>
						</div>
						<!-- Bloque de Imagen/3D eliminada -->

					</div>
					<!-- Fin de la Calculadora -->

					<!-- Contenedor de Cotización -->
					<div id="quote-display-container">
						<div id="quote-estimate-display">
							<label for="estimated-quote" class="form-label">[ COTIZACIÓN ESTIMADA (MXN) ]</label>
							<input type="text" id="estimated-quote" class="form-input text-lg text-yellow-300" readonly value="// SELECCIONA UN SERVICIO">
							<input type="hidden" name="cotizacion_estimada" id="hidden-quote">
						</div>
						<!-- Nota de Imagen/3D eliminada -->
					</div>
					
					<div>
						<label for="timeline" class="form-label">[ FECHA DE ENTREGA DESEADA ]</label>
						<input type="date" id="timeline" name="timeline" class="form-input text-lg" required>
						<div id="timeline-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
						<p id="urgency-fee-note" class="text-sm text-red-500 hidden mt-1">> Tarifa de Urgencia Aplicada: +40% sobre el total</p>
					</div>

					<div>
						<label for="brief" class="form-label">[ BRIEF / DESCRIPCIÓN DEL PROYECTO ]</label>
						<textarea id="brief" name="brief" rows="4" class="form-textarea text-lg" placeholder="Describe la visión, metas y entregables..."></textarea>
					</div>

					<div>
						<label for="assets-link" class="form-label">[ LINK DE RECURSOS (ASSETS) ]</ISO_8601>
						<input type="url" id="assets-link" name="assets-link" class="form-input text-lg" placeholder="Link a WeTransfer, Drive... (guiones, refs visuales, audio, etc.)">
						<p class="text-sm mt-1 text-gray-300/70">> Sube tus archivos a la nube y pega el link para compartir aquí.</p>
					</div>
					
					<!-- Checkbox de Términos y Condiciones -->
					<div class="flex items-start space-x-2">
						<input type="checkbox" id="terms-checkbox" name="terms" class="form-checkbox mt-1" required>
						<div class="flex-1">
							<label for="terms-checkbox" class="form-label mb-0 text-sm sm:text-base">
								Acepto los términos de servicio (pago contra-entrega, 3 revisiones, etc.)
							</label>
							<div id="terms-checkbox-error" class="form-error hidden text-red-500 text-sm mt-1"></div>
						</div>
					</div>

					<div>
						<button type="submit" id="generate-quote-btn" class="nav-link submit-btn w-full px-6 py-3 rounded-lg text-xl sm:text-2xl" disabled>
							[ GENERAR COTIZACIÓN ]
						</button>
					</div>
				</form>
				<div id="form-status" class="mt-4 text-center"></div>
			</div> <!-- Fin de content-area -->

		</main>

		<!-- Footer: Redes -->
		<footer class="absolute bottom-2 right-2 sm:bottom-4 sm:right-4 flex gap-2 sm:gap-4 text-xl sm:text-2xl md:text-3xl">
			<a href="#" class="nav-link p-2 rounded-lg" title="SoundCloud">SC</a>
			<a href="#" class="nav-link p-2 rounded-lg" title="Vimeo">VM</a>
			<a href="#" class="nav-link p-2 rounded-lg" title="Instagram">IG</a>
		</footer>

	</div>

	<!-- Modal de Confirmación de Cotización -->
	<div id="quote-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
		<!-- Overlay -->
		<div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="modal-overlay"></div>
		
		<div id="quote-modal-content" class="content-box w-full max-w-2xl z-10 p-6 flex flex-col max-h-[90vh]">
			
			<div id="quote-modal-header" class="text-center mb-4">
				<h1 class="text-5xl font-bold glitch-text" style="color: #ffffff; text-shadow: 3px 3px #00ff00, -3px -3px #ff00ff;">
					FUKURO
				</h1>
				<p class="text-2xl katakana neon-shadow">フクロウ</p>
				<p class="text-lg tracking-widest text-yellow-300" style="text-shadow: 0 0 5px #facc15;">
					A/V SYNTHESIS
				</p>
				<h2 class="text-3xl neon-shadow mt-4">++ CONFIRMAR COTIZACIÓN ++</h2>
			</div>
			
			<div id="quote-summary" class="flex-grow overflow-y-auto space-y-3 mb-6 pr-2 text-lg">
				<!-- El resumen de la cotización se inyectará aquí -->
			</div>
			
			<!-- Contenido solo para impresión -->
			<div id="quote-summary-print-container" class="hidden">
				<div class="text-center mb-6">
					<h1 class="text-5xl font-bold">FUKURO</h1>
					<p class="text-2xl katakana">フクロウ</p>
					<p class="text-xl tracking-widest">A/V SYNTHESIS</p>
					<h2 class="text-3xl mt-4">++ RESUMEN DE COTIZACIÓN ++</h2>
				</div>
				<div id="quote-summary-print" class="text-base">
					<!-- El resumen se copiará aquí -->
				</div>
			</div>

			
			<div id="modal-status" class="mt-4 text-center text-lg"></div>

			<div id="modal-controls" class="flex flex-col sm:flex-row justify-between gap-4 mt-6">
				<button id="modify-quote-btn" class="nav-link submit-btn w-full px-6 py-3 rounded-lg text-xl">
					[ MODIFICAR ]
				</button>
				<button id="print-quote-btn" class="nav-link submit-btn w-full px-6 py-3 rounded-lg text-xl">
					[ IMPRIMIR / GUARDAR ]
				</button>
				<button id="accept-quote-btn" class="nav-link submit-btn w-full px-6 py-3 rounded-lg text-xl bg-yellow-500/20 border-yellow-300 text-yellow-300 hover:bg-yellow-300 hover:text-black">
					[ ACEPTAR Y ENVIAR ]
				</button>
			</div>
		</div>
	</div>


	<!-- Lógica Principal de JavaScript -->
	<script type="module">
		import * as THREE from 'three';
		import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

		// --- Lógica de UI ---
		// La navegación y setContent se eliminan
		let currentForm = null;
		let currentFormData = null;

		// --- Lógica del Modal ---
		const modal = document.getElementById('quote-modal');
		const modifyBtn = document.getElementById('modify-quote-btn');
		const acceptBtn = document.getElementById('accept-quote-btn');
		const printBtn = document.getElementById('print-quote-btn'); 
		const modalOverlay = document.getElementById('modal-overlay');

		function showModal() {
			modal.classList.remove('hidden');
			
			// **CORRECCIÓN: Añadir el listener de impresión AQUÍ**
			printBtn.onclick = () => {
				// Copiar el resumen en vivo al div de impresión
				const summaryContent = document.getElementById('quote-summary').innerHTML;
				const printDiv = document.getElementById('quote-summary-print');
				
				// Reemplazar clases de texto (para legibilidad en impresión)
				let printContent = summaryContent
					.replace(/text-gray-300/g, 'text-black')
					.replace(/text-yellow-300/g, 'text-black font-bold')
					.replace(/text-red-500/g, 'text-red-600 font-bold')
					.replace(/text-yellow-300\/80/g, 'text-gray-700')
					.replace(/whitespace-pre-wrap/g, ''); // Quitar clase que puede dar problemas
				
				printDiv.innerHTML = printContent;
				
				// Llamar a la función de impresión del navegador
				window.print();
			};
		}
		
		function hideModal() { 
			modal.classList.add('hidden'); 
			const statusDiv = document.getElementById('modal-status');
			statusDiv.innerHTML = "";
			acceptBtn.disabled = false;
			acceptBtn.textContent = "[ ACEPTAR Y ENVIAR ]";
			
			// Limpiar el listener de impresión para evitar problemas
			if (printBtn) {
				printBtn.onclick = null; 
			}
		}

		modifyBtn.addEventListener('click', hideModal);
		modalOverlay.addEventListener('click', hideModal);
		acceptBtn.addEventListener('click', () => {
			if (currentFormData) {
				sendFormToSpree(currentFormData);
			}
		});

		// --- Lógica de Validación de Formulario Personalizada ---
		function validateForm() {
			if (!currentForm) return false;

			let isValid = true;
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

			// Ocultar todos los errores y estilos inválidos primero
			currentForm.querySelectorAll('.form-error').forEach(el => el.classList.add('hidden'));
			currentForm.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

			// 1. Validar Nombre
			const name = document.getElementById('name');
			if (name.value.trim() === '') {
				isValid = false;
				document.getElementById('name-error').textContent = "Campo requerido.";
				document.getElementById('name-error').classList.remove('hidden');
				name.classList.add('invalid');
			}

			// 2. Validar Email
			const email = document.getElementById('email');
			if (email.value.trim() === '') {
				isValid = false;
				document.getElementById('email-error').textContent = "Campo requerido.";
				document.getElementById('email-error').classList.remove('hidden');
				email.classList.add('invalid');
			} else if (!emailRegex.test(email.value)) {
				isValid = false;
				document.getElementById('email-error').textContent = "Formato de email inválido.";
				document.getElementById('email-error').classList.remove('hidden');
				email.classList.add('invalid');
			}

			// 3. Validar Nombre de Proyecto
			const projectName = document.getElementById('project-name');
			if (projectName.value.trim() === '') {
				isValid = false;
				document.getElementById('project-name-error').textContent = "Campo requerido.";
				document.getElementById('project-name-error').classList.remove('hidden');
				projectName.classList.add('invalid');
			}

			// 4. Validar Tipo de Servicio
			const service = currentForm.querySelector('input[name="service_type"]:checked');
			if (!service) {
				isValid = false;
				document.getElementById('service-type-error').textContent = "Debes seleccionar un servicio.";
				document.getElementById('service-type-error').classList.remove('hidden');
			}
			
			// 5. Validar Fecha
			const timeline = document.getElementById('timeline');
			if (timeline.value.trim() === '') {
				isValid = false;
				document.getElementById('timeline-error').textContent = "Debes seleccionar una fecha.";
				document.getElementById('timeline-error').classList.remove('hidden');
				timeline.classList.add('invalid');
			}
			
			// 6. Validar Términos
			const terms = document.getElementById('terms-checkbox');
			if (!terms.checked) {
				isValid = false;
				document.getElementById('terms-checkbox-error').textContent = "Debes aceptar los términos.";
				document.getElementById('terms-checkbox-error').classList.remove('hidden');
				terms.classList.add('invalid');
			}

			return isValid;
		}

		// --- Lógica del Calculador de Cotización ---
		function setupQuoteCalculator() {
			const calculator = document.getElementById('quote-form-calculator');
			if (!calculator) return;

			// Controles de Duración
			const durationControls = document.getElementById('duration-controls');
			const quantityInput = document.getElementById('deliverable_quantity');
			const durationMinInput = document.getElementById('duration_min'); 
			const durationSecInput = document.getElementById('duration_sec'); 
			const durationTotalMinutesInput = document.getElementById('duration_total_minutes'); 
			const isLoopCheckbox = document.getElementById('is-loop');
			const loopFinalDurationGroup = document.getElementById('loop-final-duration-group');
			const calculatedBaseFeeInput = document.getElementById('calculated_base_fee');
			const calculatedProductionFeeInput = document.getElementById('calculated_production_fee'); // Tarifa de producción TOTAL
			const existingProjectCheckbox = document.getElementById('existing-project');


			// Especificaciones Técnicas
			const techSpecsAv = document.getElementById('tech-specs-av'); 
			const formatAvInput = document.getElementById('format_av');
			const resolutionAvInput = document.getElementById('resolution_av');

			// Cotización y Fecha
			const quoteDisplayContainer = document.getElementById('quote-estimate-display');
			const quoteDisplay = document.getElementById('estimated-quote');
			const hiddenQuote = document.getElementById('hidden-quote');
			const timelineInput = document.getElementById('timeline');
			const urgencyFeeNote = document.getElementById('urgency-fee-note');

			// Botón de Envío y Términos
			const termsCheckbox = document.getElementById('terms-checkbox');
			const generateQuoteBtn = document.getElementById('generate-quote-btn');

			timelineInput.min = new Date().toISOString().split('T')[0];

			// CAMBIO: Nuevas tarifas (Base + Gradual)
			const RATES = {
				BASE_FEE: 1200, // Tarifa base única para Audio o Video
				AUDIO_TIER1: 2400, // Tasa para el primer minuto
				AUDIO_TIER2: 1200, // Tasa para minutos adicionales (50% desc)
				VIDEO_TIER1: 5000,
				VIDEO_TIER2: 2500, // Tasa para minutos adicionales (50% desc)
				URGENCY_PERCENT: 0.40
			};

			function calculateQuote() {
				const selectedService = document.querySelector('input[name="service_type"]:checked')?.value;

				const isAudio = (selectedService === 'Audio');
				const isVideo = (selectedService === 'Video');
				const isLoop = isLoopCheckbox.checked;
				const isExistingProject = existingProjectCheckbox.checked;
				
				const quantity = parseFloat(quantityInput.value) || 1;

				const minutes = parseFloat(durationMinInput.value) || 0;
				const seconds = parseFloat(durationSecInput.value) || 0;
				const durationPerItem = minutes + (seconds / 60); 
				
				// --- Lógica basada en DURACIÓN TOTAL ---
				const totalDuration = durationPerItem * quantity;
				durationTotalMinutesInput.value = totalDuration.toFixed(4); // Guardar duración total
				
				let totalBaseFee = 0;
				let totalProductionFee = 0;
				let baseQuote = 0; // baseQuote ahora es totalBaseFee + totalProductionFee
				
				const showAvControls = isAudio || isVideo;
				
				durationControls.classList.toggle('hidden', !showAvControls);
				techSpecsAv.classList.toggle('hidden', !showAvControls);
				
				
				if (isVideo) {
					formatAvInput.placeholder = ".MP4, .MOV (video) / .WAV (audio)";
					resolutionAvInput.placeholder = "4K video / 48kHz 24bit audio";
				} else if (isAudio) {
					formatAvInput.placeholder = ".WAV, .MP3, .AIF, .FLAC";
					resolutionAvInput.placeholder = "48kHz/24bit, 44.1kHz/16bit";
				}

				if (!showAvControls) {
					durationMinInput.value = 0;
					durationSecInput.value = 0;
					quantityInput.value = 1;
					isLoopCheckbox.checked = false; 
				}

				loopFinalDurationGroup.classList.toggle('hidden', !isLoop);
				if (!isLoop) {
					document.getElementById('final-duration').value = "";
				}
				
				// --- Lógica de Cálculo (Base + Producción Total Gradual) ---
				if (showAvControls && totalDuration > 0) {
					let rateTier1 = 0;
					let rateTier2 = 0;

					// 1. Tarifa Base (se cobra UNA VEZ por proyecto, si NO es existente)
					totalBaseFee = isExistingProject ? 0 : RATES.BASE_FEE;

					// 2. Tarifa de Producción (calculada sobre la DURACIÓN TOTAL)
					if (isAudio) {
						rateTier1 = RATES.AUDIO_TIER1;
						rateTier2 = RATES.AUDIO_TIER2;
					} else if (isVideo) {
						rateTier1 = RATES.VIDEO_TIER1;
						rateTier2 = RATES.VIDEO_TIER2;
					}

					if (totalDuration <= 1.0) {
						// Solo aplica la tarifa Tier 1 (incluso si es fracción)
						totalProductionFee = totalDuration * rateTier1;
					} else {
						// Aplica 1 min de Tier 1 + el resto de Tier 2
						const tier1Fee = 1.0 * rateTier1;
						const remainingDuration = totalDuration - 1.0;
						const tier2Fee = remainingDuration * rateTier2;
						totalProductionFee = tier1Fee + tier2Fee;
					}
					
					// 3. Cotización Base Total
					baseQuote = totalBaseFee + totalProductionFee;
				}
				
				// Guardar valores calculados para el modal
				calculatedBaseFeeInput.value = totalBaseFee.toFixed(2);
				calculatedProductionFeeInput.value = totalProductionFee.toFixed(2);
				// --- Fin de la Nueva Lógica ---

				let urgencyFee = 0;
				const selectedDateStr = timelineInput.value;
				if (selectedDateStr) {
					const selectedDate = new Date(selectedDateStr + "T00:00:00-06:00"); 
					const today = new Date();
					today.setHours(0, 0, 0, 0); 
					const threeDaysFromNow = new Date(today);
					threeDaysFromNow.setDate(today.getDate() + 3); 

					if (selectedDate < threeDaysFromNow && baseQuote > 0) {
						urgencyFee = baseQuote * RATES.URGENCY_PERCENT; 
						urgencyFeeNote.classList.remove('hidden');
						urgencyFeeNote.textContent = `> Tarifa de Urgencia Aplicada: +$${urgencyFee.toFixed(2)} MXN (40%)`;
					} else {
						urgencyFeeNote.classList.add('hidden');
					}
				} else {
					urgencyFeeNote.classList.add('hidden');
				}
				
				const totalQuote = baseQuote + urgencyFee;
				
				if (totalQuote > 0) {
					quoteDisplay.value = `$${totalQuote.toFixed(2)} MXN (Total)`;
				} else {
					quoteDisplay.value = "// SELECCIONA UN SERVICIO";
				}
				
				hiddenQuote.value = quoteDisplay.value;
			}
			
			// --- LISTENERS ---
			calculator.addEventListener('change', calculateQuote); 
			durationMinInput.addEventListener('input', calculateQuote); 
			durationSecInput.addEventListener('input', calculateQuote); 
			timelineInput.addEventListener('change', calculateQuote);
			
			termsCheckbox.addEventListener('change', () => {
				generateQuoteBtn.disabled = !termsCheckbox.checked;
			});

			calculateQuote();
		}

		// --- Lógica de Envío de Formulario ---
		function handleGenerateQuote(event) {
			event.preventDefault();
			
			if (!validateForm()) {
				const firstError = currentForm.querySelector('.invalid');
				if(firstError) firstError.focus();
				return;
			}

			// Llenar el campo _replyto para el filtro de spam de Formspree
			document.getElementById('form-replyto').value = document.getElementById('email').value;

			// **NUEVA LÓGICA DE ASUNTO (SUBJECT)**
			const projectName = document.getElementById('project-name').value;
			document.getElementById('form-subject').value = projectName || 'Cotización Sin Título';
			// **FIN DE NUEVA LÓGICA**

			currentFormData = new FormData(currentForm);
			
			const summaryDiv = document.getElementById('quote-summary');
			const selectedService = currentFormData.get('service_type');

			let summaryHTML = `
				<p><strong class="text-gray-300">CLIENTE:</strong> ${currentFormData.get('name') || 'N/A'}</p>
				<p><strong class="text-gray-300">EMAIL:</strong> ${currentFormData.get('email') || 'N/A'}</p>
				<p><strong class="text-gray-300">PROYECTO:</strong> ${currentFormData.get('project-name') || 'N/A'}</p>
				<hr class="border-gray-500/50 my-2">
				<p><strong class="text-gray-300">SERVICIO:</strong> ${selectedService || 'N/A'}</p>
			`;

			let specsHTML = '';
			if (selectedService === 'Audio' || selectedService === 'Video') {
				specsHTML += `<p><strong class="text-gray-300">ESPECIFICACIONES AV:</strong> ${currentFormData.get('format_av') || 'N/A'} | ${currentFormData.get('resolution_av') || 'N/A'}</p>`;
			}
			if (specsHTML) {
				summaryHTML += `${specsHTML}`;
			}

			// --- Mostrar el desglose de Tarifa Base + Producción ---
			if (selectedService === 'Audio' || selectedService === 'Video') {
				const quantity = parseFloat(currentFormData.get('deliverable_quantity')) || 1;
				const baseFee = parseFloat(currentFormData.get('calculated_base_fee')) || 0;
				const totalProductionFee = parseFloat(currentFormData.get('calculated_production_fee')) || 0;
				const totalDuration = parseFloat(currentFormData.get('duration_total_minutes')) || 0;
				const isExistingProject = currentFormData.get('existing-project');

				summaryHTML += `<p><strong class="text-gray-300">CANTIDAD:</strong> ${quantity}</p>`;
				summaryHTML += `<p><strong class="text-gray-300">CONTENIDO ÚNICO (por c/u):</strong> ${currentFormData.get('duration_min') || '0'} min ${currentFormData.get('duration_sec') || '0'} seg</p>`;
				summaryHTML += `<p><strong class="text-gray-300">DURACIÓN TOTAL (acumulada):</strong> ${totalDuration.toFixed(2)} min</p>`;

				
				if (currentFormData.get('is-loop')) {
					summaryHTML += `
						<p><strong class="text-gray-300">TIPO:</strong> Loop</p>
						<p><strong class="text-gray-300">DURACIÓN FINAL ARCHIVO:</strong> ${currentFormData.get('final-duration') || 'N/A'}</p>
					`;
				}

				summaryHTML += `<hr class="border-gray-500/50 my-2">`;
				
				if (isExistingProject) {
					 summaryHTML += `<p><strong class="text-yellow-300">TARIFA BASE (Proyecto):</strong> $0.00 MXN (Proyecto existente)</p>`;
				} else {
					 summaryHTML += `<p><strong class="text-gray-300">TARIFA BASE (Proyecto):</strong> $${baseFee.toFixed(2)} MXN</p>`;
					 summaryHTML += `<p class="text-sm text-yellow-300/80">> (La Tarifa Base es por proyecto. Se omitirá en futuros añadidos a este proyecto.)</p>`;
				}

				summaryHTML += `<p><strong class="text-gray-300">TARIFA PRODUCCIÓN (Total):</strong> $${totalProductionFee.toFixed(2)} MXN</p>`;
			}
			
			summaryHTML += `<p><strong class="text-gray-300">FECHA DE ENTREGA:</strong> ${currentFormData.get('timeline') || 'N/A'}</p>`;
			
			const urgencyFeeNote = document.getElementById('urgency-fee-note');
			if (urgencyFeeNote && !urgencyFeeNote.classList.contains('hidden')) {
				summaryHTML += `<p><strong class="text-red-500">TARIFA DE URGENCIA:</strong> ${urgencyFeeNote.textContent.split(': ')[1]}</p>`;
			}

			summaryHTML += `
				<p class="text-yellow-300 text-xl mt-4">COTIZACIÓN TOTAL: ${currentFormData.get('cotizacion_estimada')}</p>
				<p class="text-sm text-yellow-300/80 font-bold">> Cotización aproximada. Se ajustará de acuerdo a la duración final y revisiones adicionales.</p>
				
				<hr class="border-gray-500/50 my-2">
				<p><strong class="text-gray-300">BRIEF:</strong></p>
				<p class="whitespace-pre-wrap">${currentFormData.get('brief') || 'N/A'}</p>
				<hr class="border-gray-500/50 my-2">
				<p class="text-sm text-yellow-300/80">Se incluyen 3 rondas de revisión. Revisiones adicionales se cotizarán por separado.</p>
				<p class="text-sm text-yellow-300/80 font-bold">El pago total se realiza contra-entrega de los archivos finales.</p>
			`;
			
			summaryDiv.innerHTML = summaryHTML;
			showModal();
		}

		async function sendFormToSpree(formData) {
			const statusDiv = document.getElementById('modal-status');
			
			statusDiv.innerHTML = '<p class="text-yellow-300">// TRANSMITIENDO_DATOS...</p>';
			acceptBtn.disabled = true;
			acceptBtn.textContent = "[ ... ]";
			printBtn.disabled = true;
			modifyBtn.disabled = true;

			try {
				const response = await fetch(currentForm.action, {
					method: currentForm.method,
					body: formData,
					headers: {
						'Accept': 'application/json'
					}
				});

				if (response.ok) {
					statusDiv.innerHTML = `
						<p class="text-gray-200 neon-shadow">++ TRANSMISIÓN_EXITOSA ++</p>
						<p class="mt-1">// Hemos recibido tu solicitud.</p>
						<p class="text-yellow-300 mt-2">// En breve, recibirás un email con el link a tu portal de proyecto para revisiones y feedback.</p>
					`;
					currentForm.reset();
					setupQuoteCalculator();
					printBtn.disabled = true;
					modifyBtn.disabled = true;
					acceptBtn.disabled = true;
					setTimeout(hideModal, 4000); 
				} else {
					const responseData = await response.json();
					if (Object.hasOwn(responseData, 'errors')) {
						const errorMsg = responseData["errors"].map(error => error["message"]).join(", ");
						throw new Error(errorMsg);
					} else {
						throw new Error('Respuesta no-OK del servidor.');
					}
				}
			} catch (error) {
				console.error("Error al enviar formulario:", error);
				statusDiv.innerHTML = `<p class="text-red-500">-- ERROR: FALLA_TRANSMISIÓN --</p><p>// ${error.message || 'Intenta de nuevo o contacta directamente.'}</p>`;
				acceptBtn.disabled = false;
				acceptBtn.textContent = "[ ACEPTAR Y ENVIAR ]";
				printBtn.disabled = false;
				modifyBtn.disabled = false;
			}
		}

		// --- Lógica de Three.js (Sin cambios, el búho se queda) ---
		let scene, camera, renderer, mesh, clock;
		const lights = [];

		function createOwl() {
			const owlGroup = new THREE.Group();
			const material = new THREE.MeshPhysicalMaterial({
				color: 0xffffff,
				metalness: 1.0,
				roughness: 0.1,
				clearcoat: 1.0,
				clearcoatRoughness: 0.1,
				reflectivity: 1.0,
				sheen: 1.0,
				sheenColor: new THREE.Color(0x00ffff)
			});

			const bodyGeo = new THREE.SphereGeometry(1, 32, 16);
			const body = new THREE.Mesh(bodyGeo, material);
			body.scale.set(1, 1.2, 1);
			owlGroup.add(body);

			const eyeGeo = new THREE.SphereGeometry(0.3, 12, 8);
			const eyeL = new THREE.Mesh(eyeGeo, material);
			const eyeR = new THREE.Mesh(eyeGeo, material);
			eyeL.position.set(-0.4, 0.3, 0.8);
			eyeR.position.set(0.4, 0.3, 0.8);
			owlGroup.add(eyeL);
			owlGroup.add(eyeR);
			
			const pupilMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
			const pupilGeo = new THREE.SphereGeometry(0.1, 8, 8);
			const pupilL = new THREE.Mesh(pupilGeo, pupilMat);
			const pupilR = new THREE.Mesh(pupilGeo, pupilMat);
			pupilL.position.set(-0.4, 0.3, 1.05);
			pupilR.position.set(0.4, 0.3, 1.05);
			owlGroup.add(pupilL);
			owlGroup.add(pupilR);

			const beakGeo = new THREE.ConeGeometry(0.2, 0.4, 8);
			const beak = new THREE.Mesh(beakGeo, material);
			beak.position.set(0, 0.0, 1.0);
			beak.rotation.x = 0.5; 
			owlGroup.add(beak);

			const wingGeo = new THREE.SphereGeometry(0.7, 16, 8);
			const wingL = new THREE.Mesh(wingGeo, material);
			wingL.position.set(-0.8, -0.2, 0);
			wingL.scale.set(0.4, 1, 0.8);
			wingL.rotation.z = 0.3;
			owlGroup.add(wingL);

			const wingR = new THREE.Mesh(wingGeo, material);
			wingR.position.set(0.8, -0.2, 0);
			wingR.scale.set(0.4, 1, 0.8);
			wingR.rotation.z = -0.3;
			owlGroup.add(wingR);

			const tuftGeo = new THREE.ConeGeometry(0.15, 0.5, 8);
			const tuftL = new THREE.Mesh(tuftGeo, material);
			const tuftR = new THREE.Mesh(tuftGeo, material);
			tuftL.position.set(-0.5, 1.0, 0.2);
			tuftR.position.set(0.5, 1.0, 0.2);
			tuftL.rotation.z = -0.2;
			tuftR.rotation.z = 0.2;
			owlGroup.add(tuftL);
			owlGroup.add(tuftR);
			
			owlGroup.scale.set(0.8, 0.8, 0.8);
			return owlGroup;
		}

		function initThree() {
			try {
				scene = new THREE.Scene();
				clock = new THREE.Clock();
				camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
				camera.position.z = 2.5;

				const canvas = document.getElementById('three-canvas');
				renderer = new THREE.WebGLRenderer({ canvas, antias: true, alpha: true });
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				
				mesh = createOwl();
				scene.add(mesh);
				scene.add(new THREE.AmbientLight(0x404040, 0.5));

				const lightColors = [0x00ff00, 0xff00ff, 0x00ffff, 0xff0000];
				lightColors.forEach((color, index) => {
					const light = new THREE.PointLight(color, 10, 5);
					light.data = {
						offset: index * (Math.PI * 2) / lightColors.length,
						speed: 1 + Math.random()
					};
					lights.push(light);
					scene.add(light);
				});

				window.addEventListener('resize', onWindowResize);
				animate();
			} catch (error) {
				console.error("Fallo al iniciar Three.js:", error);
				document.getElementById('three-canvas').style.display = 'none';
			}
		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
		}

		function animate() {
			requestAnimationFrame(animate);
			const elapsedTime = clock.getElapsedTime();

			if (mesh) {
				mesh.rotation.x = elapsedTime * 0.1;
				mesh.rotation.y = elapsedTime * 0.2;
				mesh.position.y = Math.sin(elapsedTime * 0.5) * 0.1; 
			}
			lights.forEach((light) => {
				const t = elapsedTime * light.data.speed + light.data.offset;
				light.position.x = Math.sin(t) * 2;
				light.position.y = Math.cos(t * 0.8) * 2;
				light.position.z = Math.cos(t) * 2;
			});
			renderer.render(scene, camera);
		}

		// --- Iniciar todo ---
		// Asignar el formulario actual
		currentForm = document.getElementById('quote-form');
		if (currentForm) {
			currentForm.addEventListener('submit', handleGenerateQuote);
		}
		// Iniciar la calculadora
		setupQuoteCalculator(); 
		// Iniciar el fondo 3D
		initThree(); 

	</script>
</body>
</html>